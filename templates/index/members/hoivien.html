{% extends "index/index_layout.html" %}
{% load static %}

{% block content %}
<section class="py-16 px-4 sm:px-6 bg-green-50">
  <div class="max-w-7xl mx-auto">
    <!-- Ti√™u ƒë·ªÅ l·ªõn v·ªõi icon -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-extrabold text-green-700 tracking-tight">
        üè¢ Danh s√°ch Doanh nghi·ªáp H·ªôi vi√™n
      </h1>
      <p class="mt-2 text-gray-600">Kh√°m ph√° c√°c doanh nghi·ªáp ƒëang tham gia v√†o h·ªá sinh th√°i du l·ªãch b·ªÅn v·ªØng.</p>
    </div>

    <!-- Form t√¨m ki·∫øm & b·ªô l·ªçc -->
    <form method="get" class="flex flex-col lg:flex-row gap-4 mb-10 items-center">
      <!-- T√¨m ki·∫øm doanh nghi·ªáp -->
      <input name="search" value="{{ request.GET.search }}" placeholder="T√¨m ki·∫øm doanh nghi·ªáp..."
             class="flex-1 bg-white/50 backdrop-blur border border-gray-300 rounded-xl px-4 py-2 w-full lg:w-80 focus:ring-green-600">

      <!-- L·ªçc ng√†nh ngh·ªÅ -->
      <select name="nganh"
              class="bg-white/50 backdrop-blur border border-gray-300 rounded-xl px-3 py-2 w-full lg:w-60 focus:ring-green-600">
        <option value="">-- T·∫•t c·∫£ ng√†nh --</option>
        {% for ng in cac_nganh %}
          <option value="{{ ng }}" {% if request.GET.nganh == ng %}selected{% endif %}>{{ ng }}</option>
        {% endfor %}
      </select>

      <!-- N√∫t t√¨m ki·∫øm & ƒëƒÉng k√Ω h·ªôi vi√™n -->
      <div class="flex flex-col sm:flex-row sm:justify-between gap-4 sm:gap-6 w-full lg:w-auto">
        <!-- N√∫t t√¨m ki·∫øm -->
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow w-full sm:w-auto">
          üîç T√¨m
        </button>

        <!-- N√∫t ƒëƒÉng k√Ω h·ªôi vi√™n -->
        <a href="/members/hoivien/dangky/"
           class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl shadow w-full sm:w-auto text-center">
          ƒêƒÉng k√Ω h·ªôi vi√™n
        </a>
      </div>
    </form>

    <!-- Danh s√°ch doanh nghi·ªáp -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      {% for dn in doanh_nghiep %}
        <div 
          x-data="{ openModal: false }"
          class="group bg-white shadow-lg hover:shadow-2xl rounded-xl overflow-hidden transition-transform hover:scale-105"
        >
          <div class="h-48 overflow-hidden bg-gray-100">
            {% if dn.hinh_anh %}
              <img src="{{ dn.hinh_anh.url }}" alt="{{ dn.TEN_DN }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
            {% else %}
              <img src="{% static 'images/default-avatar.jpg' %}" alt="H√¨nh ƒë·∫°i di·ªán doanh nghi·ªáp" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
            {% endif %}
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold text-green-700 mb-1 truncate">{{ dn.TEN_DN }}</h3>
            <p class="text-gray-600 text-sm mb-3">{{ dn.DIA_CHI|truncatechars:50 }}</p>

            <!-- N√∫t m·ªü Modal -->
            <button 
              @click="openModal = true" 
              class="inline-block w-full text-center bg-green-600 text-white py-2 rounded-full hover:bg-green-700 transition duration-300">
              Xem chi ti·∫øt
            </button>

            <!-- Modal -->
            <div 
              x-show="openModal" 
              class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" 
              x-transition
              x-cloak
            >
              <div class="bg-white p-6 rounded-lg relative w-[400px] max-w-full mx-2">
                <!-- N√∫t ƒë√≥ng modal -->
                <button 
                  @click="openModal = false" 
                  class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl leading-none font-bold">‚úñÔ∏è
                </button>

                <!-- Hi·ªÉn th·ªã m√£ QR -->
                <h3 class="text-xl font-semibold text-green-700 mb-4 text-center">Qu√©t M√£ QR Doanh Nghi·ªáp</h3>
                <div class="flex justify-center mb-4">
                  {% if dn.MA_QR %}
                    <img src="{{ dn.MA_QR.url }}" alt="QR Code {{ dn.TEN_DN }}" class="w-40 h-40 object-contain">
                  {% else %}
                    <p class="text-gray-500 italic">Ch∆∞a c√≥ m√£ QR</p>
                  {% endif %}
                </div>

                <!-- N√∫t t·∫£i xu·ªëng m√£ QR -->
                {% if dn.MA_QR %}
                  <a href="{{ dn.MA_QR.url }}" download
                    class="block text-center bg-gradient-to-r from-green-500 to-green-400 text-white px-5 py-2 rounded-full text-sm font-medium hover:bg-green-600 transition duration-200 mb-3">
                    T·∫£i QR Code
                  </a>
                {% endif %}
              </div>
            </div>

            <!-- Script ki·ªÉm tra tr·∫°ng th√°i m√£ QR cho t·ª´ng doanh nghi·ªáp -->
            {% if dn.MA_DN and dn.MA_QR %}
              <script>
                (function checkQRStatus_{{ dn.MA_DN }}(){
                  setInterval(async () => {
                    try {
                      const response = await fetch(`/api/check-qr-status/{{ dn.MA_DN }}/`);
                      if (!response.ok) return;
                      const data = await response.json();
                      if (data.scanned) {
                        // N·∫øu m√£ QR ƒë√£ ƒë∆∞·ª£c qu√©t, chuy·ªÉn h∆∞·ªõng t·ªõi trang chi ti·∫øt doanh nghi·ªáp
                        window.location.href = `/members/hoivien/{{ dn.MA_DN }}/`;
                      }
                    } catch (error) {
                      console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i QR:', error);
                    }
                  }, 2000);
                })();
              </script>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="col-span-3 text-center text-gray-500">Ch∆∞a c√≥ doanh nghi·ªáp h·ªôi vi√™n.</p>
      {% endfor %}
    </div>

    <!-- Ph√¢n trang -->
    <div class="flex justify-center mt-8">
      <div class="flex gap-2 items-center">
        {% if doanh_nghiep.has_previous %}
          <a href="?page=1&search={{ request.GET.search }}&nganh={{ request.GET.nganh }}" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-all duration-300">ƒê·∫ßu</a>
          <a href="?page={{ doanh_nghiep.previous_page_number }}&search={{ request.GET.search }}&nganh={{ request.GET.nganh }}" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-all duration-300">Tr∆∞·ªõc</a>
        {% endif %}

        <span class="px-4 py-2 text-gray-700">Trang {{ doanh_nghiep.number }} / {{ doanh_nghiep.paginator.num_pages }}</span>

        {% if doanh_nghiep.has_next %}
          <a href="?page={{ doanh_nghiep.next_page_number }}&search={{ request.GET.search }}&nganh={{ request.GET.nganh }}" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-all duration-300">Ti·∫øp theo</a>
          <a href="?page={{ doanh_nghiep.paginator.num_pages }}&search={{ request.GET.search }}&nganh={{ request.GET.nganh }}" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-all duration-300">Cu·ªëi</a>
        {% endif %}
      </div>
    </div>

  </div>

</section>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

{% endblock %}
